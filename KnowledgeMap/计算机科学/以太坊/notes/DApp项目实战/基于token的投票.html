<!doctype html>
<html style='font-size:19px !important'>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet' type='text/css' /><link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="../style.css">
<link rel="stylesheet" type="text/css" href="../../style.css">
<link rel="stylesheet" type="text/css" href="../../../style.css">
<link rel="stylesheet" type="text/css" href="../../../../style.css">
<link rel="stylesheet" type="text/css" href="../../../../../style.css"><title>基于token的投票</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='基于token的投票'><span>基于token的投票</span></h1><p><span>2022.3.10</span></p><h2 id='前言'><span>前言</span></h2><p><span>在课程 “简单投票 Dapp” 中，你已经在一个模拟的区块链(ganache)上 实现了一个投票合约，并且成功地通过 nodejs 控制台和网页与合约进行了交互。 在接下来的项目学习中，我们将会实现以下内容:</span></p><ol><li><span>安装叫做 truffle 的以太坊 dapp 框架，它会被用于编译和部署我们的 合约。</span></li><li><span>在我们之前简单投票 DApp 上做一些小的更新来适配 truffle。</span></li><li><span>编译合约，并将其部署到自己的测试私链。</span></li><li><span>通过 truffle 控制台和网页与合约进行交互。</span></li><li><span>一旦你熟悉 truffle 以后，我们会对合约进行扩展，加入 token 并能够购买 token 的功能。</span></li><li><span>然后我们会对前端进行扩展，通过网页前端购买 token，并用这些token 为候选者投票。</span></li></ol><p><img src="resources/工作流.png" alt="工作流" style="zoom:50%;" /></p><h2 id='杂项'><span>杂项</span></h2><ol><li><p><span>用 Geth 启动私链</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Web - Http</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">geth <span class="cm-attribute">--datadir</span> ./mychain/ <span class="cm-attribute">--networkid</span> <span class="cm-number">15</span> <span class="cm-attribute">--dev</span> <span class="cm-attribute">--dev</span>.period <span class="cm-number">0</span> <span class="cm-attribute">--password</span> password.txt <span class="cm-attribute">--http</span> <span class="cm-attribute">--http</span>.api personal,eth,net,web3 <span class="cm-attribute">--http</span>.corsdomain <span class="cm-string">'*'</span> console <span class="cm-attribute">--allow-insecure-unlock</span> <span class="cm-number">2</span>&gt;output.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Web - WS</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">geth <span class="cm-attribute">--datadir</span> ./mychain/ <span class="cm-attribute">--networkid</span> <span class="cm-number">15</span> <span class="cm-attribute">--dev</span> <span class="cm-attribute">--dev</span>.period <span class="cm-number">0</span> <span class="cm-attribute">--password</span> password.txt <span class="cm-attribute">--ws</span> <span class="cm-attribute">--ws</span>.api personal,eth,net,web3 <span class="cm-attribute">--ws</span>.origins <span class="cm-string">'*'</span> console <span class="cm-attribute">--allow-insecure-unlock</span> <span class="cm-number">2</span>&gt;output.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Web - Ws and Http</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">geth <span class="cm-attribute">--datadir</span> ./mychain/ <span class="cm-attribute">--networkid</span> <span class="cm-number">15</span> <span class="cm-attribute">--dev</span> <span class="cm-attribute">--dev</span>.period <span class="cm-number">0</span> <span class="cm-attribute">--password</span> password.txt <span class="cm-attribute">--http</span> <span class="cm-attribute">--http</span>.api personal,eth,net,web3 <span class="cm-attribute">--http</span>.corsdomain <span class="cm-string">'*'</span> &nbsp;<span class="cm-attribute">--ws</span> <span class="cm-attribute">--ws</span>.api personal,eth,net,web3 <span class="cm-attribute">--ws</span>.origins <span class="cm-string">'*'</span> console <span class="cm-attribute">--allow-insecure-unlock</span> <span class="cm-number">2</span>&gt;output.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如果我们想到直接连接到测试网络，可以用下面的命令:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nohup geth <span class="cm-attribute">--testnet</span> <span class="cm-attribute">--syncmode</span> fast <span class="cm-attribute">--rpc</span> <span class="cm-attribute">--rpcapi</span> db,eth,net,web3,personal <span class="cm-attribute">--cache</span><span class="cm-operator">=</span><span class="cm-number">1024</span> <span class="cm-attribute">--rpcport</span> <span class="cm-number">8545</span> <span class="cm-attribute">--rpcaddr</span> <span class="cm-number">127</span>.0.0.1 <span class="cm-attribute">--rpccorsdomain</span> <span class="cm-string">"*"</span> <span class="cm-number">2</span>&gt;output.log &amp;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 405px;"></div><div class="CodeMirror-gutters" style="display: none; height: 405px;"></div></div></div></pre><p><code>--testnet</code><span>: 这是告诉 geth 启动并连接到最新的测试网络。我们所连接的网络是 Ropsten。</span></p><p><code>--syncmode fast</code><span>: 我们知道，当用 geth 连接主网或测试网络时，它必须在 本地电脑上下载整个区块链。你需要下载完整的区块链并执行每个块里面的每一 笔交易，这样你就在本地电脑上拥有了整个历史。这非常耗费时间。不过，也有 其他模式或者说优化方法，比如你只需要下载交易收据，而不用执行每一笔交易， 这就是“快速”模式。如果我们并不需要整个区块链历史，就可使用这样的 fast 模式同步区块链。</span></p><p><span>一旦你按照指示启动 geth，它会启动以太坊节点，连接到其他对端节点并开始下载区块链。下载区块链的时间取决于很多因素，比如你的网速，内存，硬盘类型等等。一台 8GB 内存，SSD 硬盘和 10 M 网速的电脑大概需要 7~8 个小时。如果你用快速模式同步 Ropsten，大概需要 6-7 GB 的硬盘空间。</span></p><p><span>用 Rinkeby 替换 Ropsten</span></p><p><span>有些同学在 Ropsten 测试网上运行 geth 会遇到问题。如果耗费时间太长 的话，你可以换一个叫做 Rinkeby 的测试网(300 多万个块，下载区块大约 1 个多小时，同步状态大约需要 4~5 个小时，到 Imported new chain segment 即 已完成同步)。下面是启动 geth 并同步 Rinkeby 网络的命令。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.25px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">geth <span class="cm-attribute">--rinkeby</span> <span class="cm-attribute">--syncmode</span> <span class="cm-string">"fast"</span> <span class="cm-attribute">--rpc</span> <span class="cm-attribute">--rpcapi</span> db,eth,net,web3,personal <span class="cm-attribute">--cache</span><span class="cm-operator">=</span><span class="cm-number">1024</span> <span class="cm-attribute">--rpcport</span> <span class="cm-number">8545</span> <span class="cm-attribute">--rpcaddr</span> <span class="cm-number">127</span>.0.0.1 <span class="cm-attribute">--rpccorsdomain</span> <span class="cm-string">"*"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 54px;"></div><div class="CodeMirror-gutters" style="display: none; height: 54px;"></div></div></div></pre><p><span>Full Sync: 从周围节点获取 block headers, block bodies, 并且从初始区块 开始重演每一笔交易以验证每一个状态</span></p><p><span>Fast Sync: 从周围节点获取 block headers, block bodies, 但不会重演交易 (只拿 receipts). 这样就会拿到所有状态的快照(不验证)，从此跟全节点一 样参与到网络中.</span></p><p><span>Light Sync: 只拿当前状态(没有历史账本数据). 如果要验证一笔交易，就必 须从另外的全节点处获取历史数据</span></p></li></ol><ol start='2' ><li><p><span>工作流(Workflow)</span></p><p><span>如果你正在构建一个基于以太坊的去中心化应用，你的 workflow 可能是像这样</span></p><p><span>Development(开发环境): Ganache </span></p><p><span>Staging/Testing(模拟/测试环境): Ropsten, Rinkeby, Kovan or your own private network </span></p><p><span>Production(生产环境): Mainnet</span></p></li><li><p><span>Truffle</span></p><ol><li><p><span>安装</span><code>npm install -g truffle</code></p></li><li><p><span>然后我们创建一个空目录，在下面创建 truffle 项目</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> simple_voting_by_truffle_dapp</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> simple_voting_by_truffle_dapp</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">npm</span> install <span class="cm-attribute">-g</span> webpack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">truffle unbox webpack</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><span>truffle init: 在当前目录初始化一个新的 truffle 空项目(项目文件只有 truffle-config.js 和 truffle.js;contracts 目录中只有 Migrations.sol;migrations 目录中只有 1_initial_migration.js)</span></p><p><span>truffle unbox: 直接下载一个 truffle box，即一个预先构建好的 truffle 项目;</span></p><p><span>unbox 的过程相对会长一点，完成之后应该看到提示</span></p><p><span>这里的 webpack 就是一个基于 webpack 构建流程的官方项目框架(truffle box)，更多 truffle box 参见 </span><a href='https://truffleframework.com/boxes' target='_blank' class='url'>https://truffleframework.com/boxes</a></p><p><span>webpack: 一个流行的前端资源依赖管理和打包工具。</span></p></li></ol></li></ol><h2 id='truffle'><span>Truffle</span></h2><ol><li><p><span>简介：truffle unbox webpack 一条命令由于要下载众多需要的模块，大概耗时 10 分钟左右，所以我们先来了解一下 Truffle。</span></p><p><span>Truffle 是目前最流行的以太坊 DApp 开发框架，(按照官网说法)是一个世界级的开发环境和测试框架，也是所有使用了 EVM 的区块链的资产管理通道，它基于 JavaScript，致力于让以太坊上的开发变得简单。Truffle 有以下功能:</span></p><ol><li><span>内置的智能合约编译，链接，部署和二进制文件的管理。 </span></li><li><span>合约自动测试，方便快速开发。</span></li><li><span>脚本化的、可扩展的部署与发布框架。</span></li><li><span>可部署到任意数量公网或私网的网络环境管理功能</span></li><li><span>使用 EthPM 和 NPM 提供的包管理，使用 ERC190 标准。</span></li><li><span>与合约直接通信的直接交互控制台(写完合约就可以命令行里验证了)。</span></li><li><span>可配的构建流程，支持紧密集成。</span></li><li><span>在 Truffle 环境里支持执行外部的脚本。</span></li></ol></li><li><p><span>Truffle 的客户端</span></p><p><span>我们之后写的智能合约必须要部署到链上进行测试，所以 truffle 构建的 DApp 也必须选择一条链来进行部署。我们可以选择部署到一些公共的测试链比 如 Rinkeby 或者 Ropsten 上，缺点是部署和测试时间比较长，而且需要花费一定的时间赚取假代币防止 out of gas。当然，对于 DApp 发布的正规流程，staging (模拟环境)还是应该用测试公链的。</span></p><p><span>还有一种方式就是部署到私链上，这在开发阶段是通常的选择。Truffle 官方推荐使用以下两种客户端:</span></p><ol><li><span>Ganache</span></li><li><span>truffle develop</span></li></ol><p><span>Ganache 我们已经接触过了，之前的简单投票小项目就是用它来做模拟区块链的。这里再介绍一点命名背景。它的前身是大名鼎鼎的 testRPC，网上的很多 truffle 教学的老文章里都是用 testRPC。Ganache 是奶油巧克力的意思，而 Truffle 是松露巧克力，一般是以 Ganache 为核，然后上面撒上可可粉，所以这两个产品的名字还是很贴切的。</span></p><p><span>而 truffle develop 是 truffle 内置的客户端，跟命令行版本的 Ganache 基本类似。在 truffle 目录下 bash 输入:</span><code>truffle develop</code><span>即可开启客户端，和 ganache 一样，它也会给我们自动生成 10 个账户。</span></p><p><span>唯一要注意的是在 truffle develop 里执行 truffle 命令的时候需要省略前面的 “truffle”，比如“truffle compile”只需要敲“compile”就可以了</span></p></li></ol><h2 id='创建-voting-项目'><span>创建 Voting 项目</span></h2><p><span>初始化一个 truffle 项目时，它会创建运行一个完整 dapp 所有必要的文件和目录。我们直接下载 webpack 这个 truffle box，它里面的目录也是类似的:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&gt;ls</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">README.md contracts node_modules test</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">webpack.config.js truffle.js app migrations package.json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&gt;ls app/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">index.html javascripts stylesheets </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&gt;ls contracts/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ConvertLib.sol MetaCoin.sol Migrations.sol</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&gt;ls migrations/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">1_initial_migration.js 2_deploy_contracts.js</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 243px;"></div><div class="CodeMirror-gutters" style="display: none; height: 243px;"></div></div></div></pre><ul><li><span>app/ - 你的应用文件运行的默认目录。这里面包括推荐的 javascript 文件和 css 样式文件目录，但你可以完全决定如何使用这些目录。</span></li><li><span>contract/ - Truffle 默认的合约文件存放目录。</span></li><li><span>migrations/ - 部署脚本文件的存放目录</span></li><li><span>test/ - 用来测试应用和合约的测试文件目录</span></li><li><span>truffle.js - Truffle 的配置文件</span></li></ul><p><span>truffle 也会创建一个你可以快速上手的示例应用(在本课程中我们并不会用到该示例应用)。你可以放心地删除项目下面 contracts 目录的 ConvertLib.sol 和 MetaCoin.sol 文件。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">rm</span> contracts/ConvertLib.sol contracts/MetaCoin.sol</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 27px;"></div><div class="CodeMirror-gutters" style="display: none; height: 27px;"></div></div></div></pre><p><span>此外，在你的项目目录下查找一个叫做 truffle.js 的配置文件。它里面包含了一个用于开发网络的配置。将端口号从 7545 改为 8545，因为我们的私链及 ganache 默认都会在该端口运行。</span></p><h2 id='migration'><span>Migration</span></h2><h3 id='migration-的概念'><span>migration 的概念</span></h3><p><span>理解 migrations(迁移)目录的内容非常重要。这些迁移文件用于将合约部署到区块链上。如果你还记得的话，我们在之前的项目中通过在 node 控制台中调用 VotingContract.new 将投票合约部署到区块链上。以后，我们再也不需要这么做了，truffle 将会部署和跟踪所有的部署。</span></p><p><span>Migrations(迁移)是 JavaScript 文件，这些文件负责暂存我们的部署任务，并且假定部署需求会随着时间推移而改变。随着项目的发展，我们应该创建新的迁移脚本，来改变链上的合约状态。所有运行过的 migration 历史记录，都会通过特殊的迁移合约记录在链上。</span></p><p><span>第一个迁移 1_initial_migration.js 向区块链部署了一个叫做 Migrations 的合约，并用于存储你已经部署的最新合约。每次你运行 migration 时，truffle会向区块链查询获取最新已部署好的合约，然后部署尚未部署的任何合约。然后它会更新 Migrations 合约中的 last_completed_migration 字段指向最新部署的合约。你可以简单地把它当成是一个数据库表，里面有一列last_completed_migration ，该列总是保持最新状态。</span></p><p><span>migration 文件的命名有特殊要求:前缀是一个数字(必需)，用来标记迁移是否运行成功;后缀是一个描述词汇，只是单纯为了提高可读性，方便理解。 </span></p><p><span>在脚本的开始，我们用 artifacts.require() 方法告诉 truffle 想要进行部署迁移的合约，这跟 node 里的 require 很类似。不过需要注意，最新的官方文档告 诫，应该传入定义的合约名称，而不要给文件名称——因为一个.sol 文件中可能 包含了多个 contract。</span></p><p><span>migration js 里的 exports 的函数，需要接收一个 deployer 对象作为第一个参数。这个对象在部署发布的过程中，主要是用来提供清晰的语法支持，同时提供一些通用的合约部署职责，比如保存部署的文件以备稍后使用。deployer 对象 是用来暂存(stage)部署任务的主要操作接口。</span></p><p><span>像所有其它在 Truffle 中的代码一样，Truffle 提供了我们自己代码的合约抽象层(contract abstractions)，并且进行了初始化，以方便你可以便利的与以太坊 的网络交互。这些抽象接口都是部署流程的一部分。</span></p><h3 id='更新-migration-文件'><span>更新 migration 文件</span></h3><p><span>将</span><code>2_deploy_contracts.js</code><span>内容更新为以下信息:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">Voting</span> <span class="cm-operator">=</span> <span class="cm-variable">artifacts</span>.<span class="cm-property">require</span>(<span class="cm-string">"./Voting.sol"</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">module</span>.<span class="cm-property">exports</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">deployer</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">deployer</span>.<span class="cm-property">deploy</span>(<span class="cm-variable">Voting</span>, [<span class="cm-string">'Alice'</span>, <span class="cm-string">'Bob'</span>, <span class="cm-string">'Cary'</span>], {<span class="cm-property">gas</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">290000</span>});</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 135px;"></div><div class="CodeMirror-gutters" style="display: none; height: 135px;"></div></div></div></pre><p><span>从上面可以看出，部署者希望第一个参数为合约名，跟在构造函数参数后面。</span></p><p><span>在我们的例子中，只有一个参数，就是一个候选者数组。第三个参数是一个哈希，我们用来指定部署代码所需的 gas。gas 数量会随着你的合约大小而变化。对于投票合约，290000 就足够了。</span></p><h3 id='更新-truffle-配置文件'><span>更新 truffle 配置文件</span></h3><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='实验记录'><span>实验记录</span></h2><p><span>2022.3.10</span></p><ol><li><span>geth命令</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.25px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">geth <span class="cm-attribute">--datadir</span> ./mychain/ <span class="cm-attribute">--networkid</span> <span class="cm-number">15</span> <span class="cm-attribute">--dev</span> <span class="cm-attribute">--dev</span>.period <span class="cm-number">0</span> <span class="cm-attribute">--password</span> password.txt <span class="cm-attribute">--http</span> <span class="cm-attribute">--http</span>.api personal,eth,net,web3 <span class="cm-attribute">--http</span>.corsdomain <span class="cm-string">'*'</span> &nbsp;<span class="cm-attribute">--ws</span> <span class="cm-attribute">--ws</span>.api personal,eth,net,web3 <span class="cm-attribute">--ws</span>.origins <span class="cm-string">'*'</span> console <span class="cm-attribute">--allow-insecure-unlock</span> <span class="cm-number">2</span>&gt;output.log</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 81px;"></div><div class="CodeMirror-gutters" style="display: none; height: 81px;"></div></div></div></pre><ol start='2' ><li><p><span>安装环境</span></p><ol><li><span>webpack</span><code>npm install webpack</code></li><li><span>truffle</span><code>npm install -g truffle@5.1.48</code></li></ol></li></ol><ol start='3' ><li><p><span>truffle</span></p><ol><li><code>truffle init</code></li><li><code>truffle unbox webpack</code></li><li></li></ol></li></ol></div></div>
</body>
</html>