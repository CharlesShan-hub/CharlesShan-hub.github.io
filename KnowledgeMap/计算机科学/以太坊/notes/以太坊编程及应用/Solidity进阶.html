<!doctype html>
<html style='font-size:19px !important'>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet' type='text/css' /><link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="../style.css">
<link rel="stylesheet" type="text/css" href="../../style.css">
<link rel="stylesheet" type="text/css" href="../../../style.css">
<link rel="stylesheet" type="text/css" href="../../../../style.css">
<link rel="stylesheet" type="text/css" href="../../../../../style.css"><title>Solidity进阶</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='solidity进阶'><span>Solidity进阶</span></h1><p><span>2022.2.21</span></p><h2 id='主要内容'><span>主要内容</span></h2><p><span>Solidity语法</span></p><h2 id='solidity源文件布局'><a href='https://solidity-cn.readthedocs.io/zh/develop/layout-of-source-files.html'><span>Solidity源文件布局</span></a></h2><ul><li><p><strong><span>pragma (版本杂注)</span></strong></p><ul><li><span>源文件可以被版本杂注pragma所注解，表明要求的编译器版本</span></li><li><span>例如:</span><code>pragma solidity ^0.4.0;</code></li><li><span>源文件将既不允许低于 0.4.0 版本的编译器编译，也不允许高于(包含) 0.5.0 版本的编译器编译(第二个条件因 使用 ^ 被添加)</span></li></ul></li><li><p><strong><span>import(导入其它源文件)</span></strong></p><ul><li><p><span>Solidity 所支持的导入语句import，语法同 JavaScript(从 ES6 起)非常类似</span></p></li><li><p><code>import &quot;filename&quot;;</code></p><p><span>从“filename”中导入所有的全局符号到当前全局作用域中</span></p></li><li><p><code>import * as symbolName from &quot;filename&quot;;</code></p><p><span>创建一个新的全局符号 symbolName，其成员均来自 “filename” 中全局符号</span></p></li><li><p><code>import {symbol1 as alias, symbol2} from &quot;filename&quot;;</code>
<span>创建新的全局符号alias和symbol2，分别从&quot;filename&quot;引用 symbol1 和 symbol2</span></p></li><li><p><code>import &quot;filename&quot; as symbolName;</code>
<span>这条语句等同于 import * as symbolName from &quot;filename&quot;;</span></p></li></ul></li></ul><h2 id='solidity值类型'><a href='https://solidity-cn.readthedocs.io/zh/develop/types.html'><span>Solidity值类型</span></a></h2><ul><li><strong><span>布尔(bool)</span></strong><span>:可能的取值为字符常量值 true 或 false</span></li></ul><ul><li><strong><span>整型(int/uint)</span></strong><span>:分别表示有符号和无符号的不同位数的整型变量; 支持关键字 uint8 到 uint256(无符号，从 8 位到 256 位)以及 int8 到 int256，以 8 位为步长递增</span></li><li><strong><span>定长浮点型(fixed / ufixed)</span></strong><span>: 表示各种大小的有符号和无符号的定长浮点型;在关键字 ufixedMxN 和 fixedMxN 中，M 表示该类型占用的位数，N 表示可用的小数位数</span></li><li><strong><span>地址(address)</span></strong><span>:存储一个 20 字节的值(以太坊地址大小)</span></li><li><strong><span>定长字节数组</span></strong><span>:关键字有 bytes1，bytes2，bytes3，...，bytes32</span></li><li><strong><span>枚举(enum)</span></strong><span>:一种用户可以定义类型的方法，与C语言类似，默认从0 开始递增，一般用来模拟合约的状态</span></li><li><strong><span>函数(function)</span></strong><span>:一种表示函数的类型</span></li></ul><h2 id='solidity引用类型'><a href='https://solidity-cn.readthedocs.io/zh/develop/types.html#index-13'><span>Solidity引用类型</span></a></h2><ul><li><p><strong><span>数组(Array)</span></strong></p><ul><li><span>数组可以在声明时指定长度(定长数组)，也可以动态调整大小(变长数组、动态数组)</span></li></ul><ul><li><span>对于</span><strong><span>存储型(storage)</span></strong><span>的数组来说，元素类型可以是</span><strong><span>任意</span></strong><span>的(即元素也可以是数组类型，映射类型或者结构体);对于</span><strong><span>内存型 (memory)</span></strong><span>的数组来说，元素类型</span><strong><span>不能是映射(mapping)类型</span></strong></li></ul></li><li><p><strong><span>结构(Struct)</span></strong></p><ul><li><span>Solidity 支持通过构造结构体的形式定义新的类型</span></li></ul></li><li><p><strong><span>映射(Mapping)</span></strong></p><ul><li><span>映射可以视作哈希表 ，在实际的初始化过程中创建每个可能的 key，并将其映射到字节形式全是零的值(类型默认值)</span></li></ul></li></ul><h2 id='solidity地址类型'><span>Solidity地址类型</span></h2><ul><li><p><span>address</span></p><ul><li><span>地址类型存储一个 20 字节的值(以太坊地址的大小);地址类型也有成员变量，并作为所有合约的基础</span></li></ul></li><li><p><span>address payable(v0.5.0引入)</span></p><ul><li><span>与地址类型基本相同，不过多出了 transfer 和 send 两个成员变量</span></li></ul></li><li><p><span>两者区别和转换</span></p><ul><li><span>Payable 地址是可以发送 ether 的地址，而普通 address 不能允许从 payable address 到 address 的隐式转换，而反过来的直接转换是不可能的(唯一方法是通过uint160来进行中间转换)</span></li></ul><ul><li><span>从0.5.0版本起，合约不再是从地址类型派生而来，但如果它有payable的回退函数，那同样可以显式转换为 address 或者 address payable 类型</span></li></ul></li><li><p><code>&lt;address&gt;.balance (uint256)</code><span>:该地址的 ether 余额，以Wei为单位</span></p></li><li><p><code>&lt;address payable&gt;.transfer(uint256 amount)</code><span>:向指定地址发送数量为 amount 的 ether(以Wei为单位)，失败时抛出异常，发送 2300 gas 的矿工费，不可调节</span></p><ul><li><strong><span>注意是向address send代币！</span></strong></li></ul></li><li><p><code>&lt;address payable&gt;.send(uint256 amount) returns (bool)</code><span>:向指定地址发送数量为 amount的 ether(以Wei为单位)，失败时返回 false，发送 2300 gas 的矿工费用，不可调节</span></p><ul><li><strong><span>注意是向address send代币！</span></strong></li><li><strong><span>send没有异常，所以默认是执行成功的！</span></strong></li></ul></li><li><p><code>&lt;address&gt;.call(bytes memory) returns (bool, bytes memory)</code><span>:发出底层函数 CALL，失败时返回 false，</span><strong><span>发送所有可用 gas</span></strong><span>，可调节 </span></p><ul><li><span>失败没有异常</span></li></ul></li><li><p><code>&lt;address&gt;.delegatecall(bytes memory) returns (bool, bytes memory)</code><span>:发出底层函数 DELEGATECALL，代理调用，失败时返回 false，</span><strong><span>发送所有可用 gas</span></strong><span>，可调节 </span></p></li><li><p><code>&lt;address&gt;.staticcall(bytes memory) returns (bool, bytes memory)</code><span>:发出底层函数 STATICCALL ，失败时返回 false，</span><strong><span>发送所有可用 gas</span></strong><span>，可调节</span></p></li><li><p><span>地址成员变量用法</span></p><ul><li><p><strong><span>balance 和 transfer</span></strong></p><ul><li><p><span>可以使用balance属性来查询一个地址的余额，可以使用transfer函数向一个payable地址发送 以太币Ether(以 wei 为单位) </span></p></li><li><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-type">address</span> <span class="cm-type">payable</span> <span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-type">address</span>(<span class="cm-number">0x123</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-type">address</span> <span class="cm-variable">myAddress</span> <span class="cm-operator">=</span> <span class="cm-type">address</span>(<span class="cm-keyword">this</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-variable">x</span>.<span class="cm-variable">balance</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">myAddress</span>.<span class="cm-variable">balance</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">10</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">x</span>.<span class="cm-variable">transfer</span>(<span class="cm-number">10</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre></li></ul></li><li><p><strong><span>send</span></strong></p><ul><li><span>send 是 transfer 的低级版本。如果执行失败，当前的合约不会因为异 常而终止，但 send 会返回 false</span></li></ul></li><li><p><strong><span>call</span></strong></p><ul><li><p><span>也可以用call来实现转币的操作，通过添加.gas()和.value()修饰器: </span></p></li><li><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.25px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">nameReg</span>.<span class="cm-variable">call</span>.<span class="cm-variable">gas</span>(<span class="cm-number">1000000</span>).<span class="cm-variable">value</span>(<span class="cm-number">1</span> <span class="cm-keyword">ether</span>)(<span class="cm-keyword">abi</span>.<span class="cm-keyword">encodeWithSignature</span>(<span class="cm-string">"register(string)", "MyName"</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 54px;"></div><div class="CodeMirror-gutters" style="display: none; height: 54px;"></div></div></div></pre></li></ul></li></ul></li></ul><h2 id='字符数组byte-arrays'><span>字符数组(Byte Arrays)</span></h2><p><strong><span>定长字符数组</span></strong></p><ul><li><span>属于值类型，bytes1，bytes2，...，bytes32分别代表了长度为1到32的字</span></li></ul><p><strong><span>节序列</span></strong></p><ul><li><p><span>有一个</span><strong><span>.length</span></strong><span>属性，返回数组长度(只读)</span></p></li><li><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">test</span>() <span class="cm-keyword">public</span> <span class="cm-keyword">pure</span> <span class="cm-keyword">return</span>(<span class="cm-variable">unit</span>){ <span class="cm-comment">// 最后函数输出17</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-type">bytes17</span> <span class="cm-variable">a</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">a</span>.<span class="cm-variable">length</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre></li></ul><p><strong><span>变长字符数组</span></strong></p><ul><li><span>属于引用类型，包括 bytes和string，不同的是bytes是Hex字符串，而string是UTF-8编码的字符串</span></li></ul><h2 id='枚举enum'><span>枚举(Enum)</span></h2><ul><li><span>枚举类型用来用户自定义一组常量值</span></li><li><span>与C语言的枚举类型非常相似，对应整型值</span></li><li><strong><span>枚举类型、结构类型、状态变量需要在函数外声明！！</span></strong></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;=</span><span class="cm-number">0.4.0</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Purchase</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 枚举类型、结构类型、状态变量需要在函数外声明！！</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">enum</span> <span class="cm-def">State</span> { <span class="cm-variable">Created</span>, <span class="cm-variable">Locked</span>, <span class="cm-variable">Inactive</span> } </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">test</span>() <span class="cm-keyword">public</span> <span class="cm-keyword">pure</span> <span class="cm-keyword">return</span>(<span class="cm-variable">unit</span>){ <span class="cm-comment">// 最后函数输出17</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">State</span> <span class="cm-variable">st</span> <span class="cm-operator">=</span> <span class="cm-variable">State</span>.<span class="cm-variable">Created</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-type">uint</span>(<span class="cm-variable">st</span>); <span class="cm-comment">// Created, Locked, Inactive 分别是0,1,2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 243px;"></div><div class="CodeMirror-gutters" style="display: none; height: 243px;"></div></div></div></pre><h2 id='数组array'><span>数组(Array)</span></h2><ul><li><p><span>固定大小k和元素类型T的数组被写为T[k]，动态大小的数组为T[]。</span></p><p><strong><span>例如，一个由5个uint动态数组组成的数组是uint[]</span><span>[</span><span>5]</span></strong><span>(定义的时候，和C语言顺序是不一样的)</span></p></li><li><p><span>要</span><strong><span>访问第三个动态数组中的第二个uint，可以使用x[2]</span><span>[</span><span>1]</span></strong><span>（访问的时候，和C语言顺序是一样的）</span></p></li><li><p><span>越界访问数组，会导致调用失败回退</span></p></li><li><p><span>如果要添加新元素，则必须使用.push()或将.length增大, (</span><strong><span>如果存在storage里边，长度可以变，如果存在memory里边，长度不能变</span></strong><span>)</span></p></li><li><p><span>变长的storage数组和bytes(不包括string)有一个push()方法。可以将一个新元素附加到数组末端，返回值为当前长度</span></p></li><li><p><span>数组示例</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;=</span><span class="cm-number">0.4.16</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">C</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">f</span>(<span class="cm-type">uint</span> <span class="cm-variable">len</span>) <span class="cm-keyword">public</span> <span class="cm-keyword">pure</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span>[] <span class="cm-keyword">memory</span> <span class="cm-variable">a</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-type">uint</span>[](<span class="cm-number">7</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">bytes</span> <span class="cm-keyword">memory</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-type">bytes</span>(<span class="cm-variable">len</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">assert</span>(<span class="cm-variable">a</span>.<span class="cm-variable">length</span> <span class="cm-operator">==</span> <span class="cm-number">7</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">assert</span>(<span class="cm-variable">b</span>.<span class="cm-variable">length</span> <span class="cm-operator">==</span> <span class="cm-variable">len</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">a</span>[<span class="cm-number">6</span>] <span class="cm-operator">=</span> <span class="cm-number">8</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  } </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 270px;"></div><div class="CodeMirror-gutters" style="display: none; height: 270px;"></div></div></div></pre></li></ul><h2 id='结构struct'><a href='https://solidity-cn.readthedocs.io/zh/develop/types.html#structs'><span>结构(Struct)</span></a></h2><ul><li><span>结构类型可以在映射和数组中使用，它们本身可以包含映射和数组。</span></li><li><strong><span>结构不能包含自己类型的成员</span></strong><span>，但可以作为自己数组成员的类型，也可以作为自己映射成员的值类型</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;=</span><span class="cm-number">0.4.0</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Ballot</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">struct</span> <span class="cm-def">Voter</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-variable">weight</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">bool</span> <span class="cm-variable">voted</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-variable">vote</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><h2 id='映射mapping'><span>映射(Mapping)</span></h2><ul><li><span>声明一个映射:</span><code>mapping(_KeyType =&gt; _ValueType)</code></li><li><span>_KeyType可以是任何基本类型。这意味着它可以是任何内置值类型加上字符数组和字符串。</span><strong><span>不允许使用用户定义的或复杂的类型，如枚举，映射，结构以及除bytes和string之外的任何数组类型</span></strong><span>。 </span></li><li><span>_ValueType可以是任何类型，包括映射。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;=</span><span class="cm-number">0.4.0</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">MappingExample</span> { </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">mapping</span>(<span class="cm-type">address</span> <span class="cm-operator">=&gt;</span> <span class="cm-type">uint</span>) <span class="cm-def">public</span> <span class="cm-variable">balances</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">update</span>(<span class="cm-type">uint</span> <span class="cm-variable">newBalance</span>) <span class="cm-keyword">public</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">balances</span>[<span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span>] <span class="cm-operator">=</span> <span class="cm-variable">newBalance</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">contract</span> <span class="cm-def">MappingUser</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">f</span>() <span class="cm-keyword">public</span> <span class="cm-keyword">returns</span> (<span class="cm-type">uint</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">MappingExample</span> <span class="cm-variable">m</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MappingExample</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">m</span>.<span class="cm-variable">update</span>(<span class="cm-number">100</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">m</span>.<span class="cm-variable">balances</span>(<span class="cm-type">address</span>(<span class="cm-keyword">this</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 432px;"></div><div class="CodeMirror-gutters" style="display: none; height: 432px;"></div></div></div></pre><ul><li><span>下面是上课讲的例子，比较绕：</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">^</span><span class="cm-number">0.8.0</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">C</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">mapping</span> (<span class="cm-type">address</span><span class="cm-operator">=&gt;</span><span class="cm-type">uint</span>) <span class="cm-def">public</span> <span class="cm-variable">balances</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">constructor</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">balances</span>[<span class="cm-type">address</span>(<span class="cm-keyword">this</span>)]<span class="cm-operator">=</span><span class="cm-number">300</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">update</span>(<span class="cm-type">uint</span> <span class="cm-variable">amount</span>)<span class="cm-keyword">public</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">balances</span>[<span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span>]<span class="cm-operator">=</span><span class="cm-variable">amount</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">D</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">test1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">test2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">test3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">test</span>()<span class="cm-keyword">public</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">C</span> <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">C</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">c</span>.<span class="cm-variable">update</span>(<span class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">test1</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>.<span class="cm-variable">balances</span>(<span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">test2</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>.<span class="cm-variable">balances</span>(<span class="cm-type">address</span>(<span class="cm-keyword">this</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">test3</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>.<span class="cm-variable">balances</span>(<span class="cm-type">address</span>(<span class="cm-variable">c</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 675px;"></div><div class="CodeMirror-gutters" style="display: none; height: 675px;"></div></div></div></pre><p><span>应该返回300，10，0.因为c.update传入的参数，是调用他的地址，address(c)是c的地址，在合约C创建的时候，c的balances就是300；address(this)的this是D，fun()中的c.update传入了D的地址，所以d的balances经过updated成了10；c.balances(msg.sender)获取的是用户的地址对应的balances，并没有设置过，是0。</span></p><p><span>运行结果贴图：</span></p><p><img src="resources/address.png" alt="address" style="zoom:50%;" /></p><h2 id='solidity数据位置'><span>Solidity数据位置</span></h2><ul><li><span>所有的复杂类型，即数组、结构和映射类型，都有一个额外属性，“数据位置”，用来说明数据是保存在内存 memory 中还是 存储 storage 中</span></li><li><span>根据上下文不同，大多数时候数据有默认的位置，但也可以通过在类型名后增加关键字 storage 或 memory 进行修改</span></li><li><span>函数</span><strong><span>参数</span></strong><span>(包括返回的参数)的数据位置默认是</span><strong><span>memory</span></strong><span>，</span><strong><span>局部变量</span></strong><span>的数据位置默认是 </span><strong><span>storage</span></strong><span>，</span><strong><span>状态变量</span></strong><span>的数据位置强制是 </span><strong><span>storage</span></strong></li><li><span>另外还存在第三种数据位置，calldata，这是一块只读的，且不会永久存储的位置，用来存储函数参数。外部函数的参数(非返回参数) 的数据位置被强制指定为 calldata ，效果跟 memory 差不多</span></li></ul><h2 id='数据位置总结'><span>数据位置总结</span></h2><ul><li><p><strong><span>强制指定</span></strong><span>的数据位置</span></p><ul><li><strong><span>外部函数的参数</span></strong><span>(不包括返回参数):</span><strong><span>calldata</span></strong><span>;</span></li></ul><ul><li><strong><span>状态变量</span></strong><span>:</span><strong><span>storage</span></strong></li></ul></li></ul><ul><li><p><strong><span>默认</span></strong><span>数据位置</span></p><ul><li><strong><span>函数参数</span></strong><span>(包括返回参数):</span><strong><span>memory</span></strong><span>;</span></li><li><strong><span>引用类型的局部变量</span></strong><span>:</span><strong><span>storage</span></strong></li><li><strong><span>值类型的局部变量</span></strong><span>:</span><strong><span>栈(stack)</span></strong></li></ul></li><li><p><span>特别要求</span></p><ul><li><span>公开可见(</span><strong><span>public</span></strong><span>lyvisible)的函数参数一定是</span><strong><span>memory</span></strong><span>类型，如果要求是 storage 类型则必须是 private 或者 internal 函数，这是为了防止随意的公开调用占用资源</span></li></ul></li></ul><h2 id='案例程序'><span>案例程序</span></h2><h3 id='数组案例'><span>数组案例</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">^</span><span class="cm-number">0.8.0</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">C</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span>[] <span class="cm-keyword">public</span> <span class="cm-variable">data1</span>; <span class="cm-comment">// 默认存在storgae,不定长度只存头，剩下的散列出去</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span>[] <span class="cm-keyword">public</span> <span class="cm-variable">data2</span>; <span class="cm-comment">// 默认存在storgae</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">checkLength</span>() <span class="cm-keyword">view</span> <span class="cm-keyword">public</span> <span class="cm-keyword">returns</span>(<span class="cm-type">uint</span>,<span class="cm-type">uint</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> (<span class="cm-variable">data1</span>.<span class="cm-variable">length</span>,<span class="cm-variable">data2</span>.<span class="cm-variable">length</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">appendOne</span>(<span class="cm-type">uint8</span> <span class="cm-variable">data</span>) <span class="cm-keyword">public</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">append</span>(<span class="cm-variable">data1</span>,<span class="cm-variable">data</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">appendTwo</span>(<span class="cm-type">uint8</span> <span class="cm-variable">data</span>) <span class="cm-keyword">public</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">append</span>(<span class="cm-variable">data2</span>,<span class="cm-variable">data</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">append</span>(<span class="cm-type">uint</span>[] <span class="cm-keyword">storage</span> <span class="cm-variable">d</span>,<span class="cm-type">uint8</span> <span class="cm-variable">data</span>) <span class="cm-keyword">internal</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// d只是data1或data2的引用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">d</span>.<span class="cm-variable">push</span>(<span class="cm-variable">data</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 486px;"></div><div class="CodeMirror-gutters" style="display: none; height: 486px;"></div></div></div></pre><p><span>运行截图：</span></p><p><span>（appendOne和appendTwo已经输入了多个数，截图展示的是最后一个；data1和data2是输入下标点击显示对应内容）</span></p><p><img src="resources/数组.png" alt="数组" style="zoom:50%;" /></p><h3 id='程序改错1'><span>程序改错1</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 下面代码包含一个错误 </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">^</span><span class="cm-number">0.4.0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">C</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">a</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">b</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span>[] <span class="cm-variable">data</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">f</span>() <span class="cm-keyword">public</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-type">uint</span>[] <span class="cm-variable">x</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">x</span>.<span class="cm-variable">push</span>(<span class="cm-number">2</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>} </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 351px;"></div><div class="CodeMirror-gutters" style="display: none; height: 351px;"></div></div></div></pre><p><img src="resources/magic.gif" alt="magic" style="zoom:67%;" /></p><p><span>这是因为</span><code>uint[] x;</code><span>定义的时候没有初始化，形成了野指针，指针默认指向程序开头。长度可变的数组在存储过程中，会存储这个数组的长度。所以会产生错误。</span></p><h3 id='程序改错2'><span>程序改错2</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 下面代码编译错误 </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">^</span><span class="cm-number">0.4.0</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">C</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span>[] <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">f</span>(<span class="cm-type">uint</span>[] <span class="cm-variable">memoryArray</span>) <span class="cm-keyword">public</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 这个是可以的，memory给storage类型赋值：会进行数据的拷贝</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-variable">memoryArray</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 这个是可以的，这个局部变量y只当一个引用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span>[] <span class="cm-variable">y</span> <span class="cm-operator">=</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 如果没越界是可以的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">y</span>[<span class="cm-number">7</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 是可以的，storage的可变数组可以直接用.length</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">y</span>.<span class="cm-variable">length</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 是可以的，软删除（把长度置为零）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">delete</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// TypeError: Type uint256[] memory is not implicitly convertible to expected type uint256[] storage pointer.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// memory类型的变长数组（可以认为无限大），不能直接指向y这一块很小的内存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">y</span> <span class="cm-operator">=</span> <span class="cm-variable">memoryArray</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">delete</span> <span class="cm-variable">y</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">g</span>(<span class="cm-variable">x</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">h</span>(<span class="cm-variable">x</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">// 如果传入类型为storage，函数类型只能是internal或private而不能是public</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">g</span>(<span class="cm-type">uint</span>[] <span class="cm-keyword">storage</span> <span class="cm-variable">storageArray</span>) <span class="cm-keyword">internal</span> {} </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">h</span>(<span class="cm-type">uint</span>[] <span class="cm-variable">memoryArray</span>) <span class="cm-keyword">public</span> {} </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 729px;"></div><div class="CodeMirror-gutters" style="display: none; height: 729px;"></div></div></div></pre><ul><li><span>memory给storage类型赋值：会进行数据的拷贝</span></li><li><span>storage给状态变量storage类型赋值：会进行数据的拷贝</span></li><li><span>storage给局部变量storage类型赋值：这个局部变量只当一个引用</span></li><li><code>function f(uint[] memoryArray) public {</code><span>在0.8.n里边，需要指定成</span><code>calldata</code><span>或</span><code>memory</code><span>!</span></li><li><code>uint[] y = x;</code><span>在0.8.n里边也不被允许，需要指定类型。如果类型为</span><code>memory</code><span>后边的</span><code>y.length=2</code><span>就又错了</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.181ex" role="img" focusable="false" viewBox="0 -511 1000 522" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.025ex;"><defs><path id="MJX-9-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="2192" xlink:href="#MJX-9-TEX-N-2192"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo accent="false" stretchy="false">→</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">\to</script><span>memory类型的变量给定了后就不能变了</span></li><li><code>y = memoryArray</code><span>中的</span><code>`y</code><span>如果是storage类型的，就会失败；只有memory类型才会成功</span></li></ul><h3 id='猜数字游戏'><span>猜数字游戏</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;</span><span class="cm-number">0.4.22</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Honeypot</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-type">uint</span> <span class="cm-variable">luckyNum</span> <span class="cm-operator">=</span> <span class="cm-number">52</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">last</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">struct</span> <span class="cm-def">Guess</span>{ <span class="cm-type">address</span> <span class="cm-variable">player</span>; <span class="cm-type">uint</span> <span class="cm-variable">number</span>; } </span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Guess</span>[] <span class="cm-keyword">public</span> <span class="cm-variable">guessHistory</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-type">address</span> <span class="cm-variable">owner</span> <span class="cm-operator">=</span> <span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">guess</span>(<span class="cm-type">uint</span> <span class="cm-variable">_num</span>) <span class="cm-keyword">public</span> <span class="cm-keyword">payable</span>{</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Guess</span> <span class="cm-variable">newGuess</span>; </span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">newGuess</span>.<span class="cm-variable">player</span> <span class="cm-operator">=</span> <span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span>; </span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">newGuess</span>.<span class="cm-variable">number</span> <span class="cm-operator">=</span> <span class="cm-variable">_num</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">guessHistory</span>.<span class="cm-variable">push</span>( <span class="cm-variable">newGuess</span> ); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span>( <span class="cm-variable">_num</span> <span class="cm-operator">==</span> <span class="cm-variable">luckyNum</span> )</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span>.<span class="cm-variable">transfer</span>( <span class="cm-keyword">msg</span>.<span class="cm-keyword">value</span> <span class="cm-operator">*</span> <span class="cm-number">2</span> ); </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">last</span> <span class="cm-operator">=</span> <span class="cm-keyword">now</span>;</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>} </span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 459px;"></div><div class="CodeMirror-gutters" style="display: none; height: 459px;"></div></div></div></pre><p><code>Guess newGuess;</code><span>错误在这里！还是指针没赋初始值</span></p><h2 id='solidity函数声明和类型'><span>Solidity函数声明和类型</span></h2><p><span>函数的值类型有两类: </span><strong><span>内部(internal)函数</span></strong><span>和</span><strong><span>外部(external)函数</span></strong></p><ul><li><span>内部函数只能在当前</span><strong><span>合约内</span></strong><span>被调用(更具体来说，在当前代码内，包括内 部库函数和继承的函数中)，因为它们不能在当前合约上下文的外部被执行。调用一个内部函数是通过跳转到它的入口标签来实现的，就像在当前合约的内部调用一个函数。</span></li><li><span>外部函数由一个地址和一个函数签名组成，可以通过外部函数调用传递或者返回</span></li><li><span>调用内部函数:直接使用名字 f</span></li><li><span>调用外部函数:this.f(当前合约)，a.f(外部合约)</span></li></ul><h2 id='solidity函数可见性'><span>Solidity函数可见性</span></h2><ul><li><span>函数的可见性可以指定为 </span><code>external</code><span>，</span><code>public</code><span> ，</span><code>internal</code><span> 或者 </span><code>private</code><span>; 对于状态变量,不能设置为 </span><code>external</code><span> ，默认是 </span><code>internal</code><span>。</span></li><li><code>external</code><span>:外部函数作为合约接口的一部分，意味着我们可以从其他合约和交易中调用。一个外部函数f不能从内部调用(即 f 不起作用，但 this.f() 可以)。 当收到大量数据的时候, 外部函数有时候会更有效率。</span></li><li><code>public</code><span> :public 函数是合约接口的一部分，可以在内部或通过消息调用。 对于 public 状态变量，会自动生成一个 getter 函数。</span></li><li><code>internal</code><span>:这些函数和状态变量只能是内部访问(即从当前合约内部或从它派生的合约访问)，不使用 this 调用。</span></li><li><code>private</code><span>:private函数和状态变量仅在当前定义它们的合约中使用，并且不能被派生合约使用。</span></li></ul><ul><li><p><span>函数可见性实例</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;=</span><span class="cm-number">0.4.16</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">C</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">f</span>(<span class="cm-type">uint</span> <span class="cm-variable">a</span>) <span class="cm-keyword">private</span> <span class="cm-keyword">pure</span> <span class="cm-keyword">returns</span> (<span class="cm-type">uint</span> <span class="cm-variable">b</span>) { </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">a</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">setData</span>(<span class="cm-type">uint</span> <span class="cm-variable">a</span>) <span class="cm-keyword">internal</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">a</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-type">uint</span> <span class="cm-keyword">public</span> <span class="cm-variable">data</span>; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span> <span class="cm-def">x</span>() <span class="cm-keyword">public</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>; <span class="cm-comment">// 内部访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">data</span>(); <span class="cm-comment">// 外部访问 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">uint</span> <span class="cm-variable">val2</span> <span class="cm-operator">=</span> <span class="cm-variable">f</span>(<span class="cm-variable">data</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  } </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 459px;"></div><div class="CodeMirror-gutters" style="display: none; height: 459px;"></div></div></div></pre></li></ul><p>&nbsp;</p><h2 id='solidity函数状态可变性'><span>Solidity函数状态可变性</span></h2><ul><li><code>pure</code><span>: 纯函数，不允许修改或访问状态</span></li><li><code>view</code><span>: 不允许修改状态</span></li><li><code>payable</code><span>: 允许从消息调用中接收以太币Ether</span></li><li><code>constant</code><span>: 与view相同，一般只修饰状态变量，不允许赋值 (除初始化以外)</span></li></ul><ul><li><p><span>以下情况被认为是</span><strong><span>修改状态</span></strong><span>:</span></p><ul><li><span>修改状态变量。</span></li><li><span>产生事件。</span></li><li><span>创建其它合约。</span></li><li><span>使用 selfdestruct。</span></li><li><span>通过调用发送以太币。</span></li><li><span>调用任何没有标记为 view 或者 pure 的函数。</span></li><li><span>使用低级调用。</span></li><li><span>使用包含特定操作码的内联汇编。</span></li></ul></li></ul><ul><li><p><span>以下被认为是从状态中进行读取:</span></p><ul><li><span>读取状态变量。</span></li><li><span>访问 this.balance 或者 </span><address><span>.balance。</span></li><li><span>访问 block，tx， msg 中任意成员 (除 msg.sig 和 msg.data 之外)。</span></li><li><span>调用任何未标记为pure的函数。</span></li><li><span>使用包含某些操作码的内联汇编。</span></li></ul></li></ul><h2 id='函数修饰器modifier'><span>函数修饰器(modifier)</span></h2><ul><li><p><span>使用修饰器modifier可以轻松改变函数的行为。例如，它们可以在执行函数之前自动检查某个条件。修饰器modifier 是合约的可继承属性，并可能被派生合约覆盖</span></p></li><li><p><span>如果同一个函数有多个修饰器modifier，它们之间以空格隔开，修饰器modifier会依次检查执行。</span></p></li><li><p><span>Modifier示例</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;=</span><span class="cm-number">0.4.22</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>; </span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Purchase</span> {</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">address</span> <span class="cm-keyword">public</span> <span class="cm-variable">seller</span>;</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">modifier</span> <span class="cm-def">onlySeller</span>() { <span class="cm-comment">// Modifier</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">require</span>( <span class="cm-keyword">msg</span>.<span class="cm-keyword">sender</span> <span class="cm-operator">==</span> <span class="cm-variable">seller</span>, <span class="cm-string">"Only seller can call."</span> );</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">_</span>; &nbsp;<span class="cm-comment">// 这是一个占位符，代表被修饰代码</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">abort</span>() <span class="cm-keyword">public</span> <span class="cm-keyword">view</span> <span class="cm-variable">onlySeller</span> <span class="cm-keyword">returns</span>(...){ <span class="cm-comment">// Modifier usage</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 297px;"></div><div class="CodeMirror-gutters" style="display: none; height: 297px;"></div></div></div></pre><p>&nbsp;</p></li></ul><h2 id='回退函数fallback'><span>回退函数(fallback)</span></h2><ul><li><span>回退函数(fallbackfunction)是合约中的特殊函数; 没有名字，不能有参数也不能有返回值</span></li><li><strong><span>如果在一个到合约的调用中，没有其他函数与给定的函数标识符匹配 (或没有提供调用数据)，那么这个函数(fallback 函数)会被执行</span></strong></li></ul><ul><li><span>每当合约收到以太币(没有任何数据)，回退函数就会执行。此外， 为了接收以太币，fallback 函数必须标记为 payable。如果不存在这样的函数，则合约不能通过常规交易接收以太币</span></li><li><span>在上下文中通常只有很少的gas可以用来完成回退函数的调用，所以使 fallback 函数的调用尽量廉价很重要</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">pragma</span> <span class="cm-variable">solidity</span> <span class="cm-operator">&gt;</span><span class="cm-number">0.4.99</span> <span class="cm-operator">&lt;</span><span class="cm-number">0.6.0</span>; </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Sink</span> {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 这是一个回退函数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">function</span>() <span class="cm-def">external</span> <span class="cm-keyword">payable</span> { }</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Test</span> {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">// 这是一个回退函数</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span>() <span class="cm-def">external</span> { <span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; }</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-type">uint</span> <span class="cm-variable">x</span>; </span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">contract</span> <span class="cm-def">Caller</span> {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 把合约当成一个参数传了进来</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">function</span> <span class="cm-def">callTest</span>(<span class="cm-variable">Test</span> <span class="cm-variable">test</span>) <span class="cm-keyword">public</span> <span class="cm-keyword">returns</span> (<span class="cm-type">bool</span>) {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 调用了一个没有定义的函数来触发回退函数</span></span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  (<span class="cm-type">bool</span> <span class="cm-variable">success</span>,) <span class="cm-operator">=</span> <span class="cm-type">address</span>(<span class="cm-variable">test</span>).<span class="cm-variable">call</span>(<span class="cm-keyword">abi</span>.<span class="cm-keyword">encodeWithSignature</span>(<span class="cm-string">"nonExistingFunction()"</span>));</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">require</span>(<span class="cm-variable">success</span>);</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 把一个普通的地址类型，转换成一个payable的地址类型</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-type">address</span> <span class="cm-type">payable</span> <span class="cm-variable">testPayable</span> <span class="cm-operator">=</span> <span class="cm-type">address</span>(<span class="cm-type">uint160</span>(<span class="cm-type">address</span>(<span class="cm-variable">test</span>))); </span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">testPayable</span>.<span class="cm-variable">send</span>(<span class="cm-number">2</span> <span class="cm-keyword">ether</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 621px;"></div><div class="CodeMirror-gutters" style="display: none; height: 621px;"></div></div></div></pre><h2 id='事件event'><span>事件(event)</span></h2><p><span>• 事件是以太坊EVM提供的一种日志基础设施。事件可以用来做操作记录，存储为日志。也可以用来实现一些交互功能，比如通知UI，返回函数调用结果等</span></p><p><span>• 当定义的事件触发时，我们可以将事件存储到EVM的交易日志中，日志是区块链中的一种特殊数据结构;日志与合约关联，与合约的存储合并存入区块链中;只要某个区块可以访问，其相关的日志就可以访 问;但在</span><strong><span>合约中，我们不能直接访问日志和事件数据</span></strong></p><p><span>• 可以通过日志实现简单支付验证SPV(SimplifiedPayment Verification)，如果一个外部实体提供了一个带有这种证明的合约，它可以检查日志是否真实存在于区块链中</span></p><h2 id='solidity异常处理'><span>Solidity异常处理</span></h2><ul><li><span>Solidity使用“状态恢复异常”来处理异常。这样的异常将撤消对 当前调用(及其所有子调用)中的状态所做的所有更改，并且向 调用者返回错误。</span></li><li><span>函数assert和require可用于判断条件，并在不满足条件时抛出异常</span></li><li><span>assert()一般只应用于测试内部错误，并检查常量</span></li><li><span>require()应用于确保满足有效条件(如输入或合约状态变量)，或验证调用外部合约的返回值</span></li><li><span>revert()用于抛出异常，它可以标记一个错误并将当前调用回退</span></li></ul><h2 id='solidity中的单位'><span>Solidity中的单位</span></h2><ul><li><span>以太币 Ether 单位之间的换算就是在数字后边加上 </span><code>wei</code><span>、 </span><code>finney</code><span>、 </span><code>szabo</code><span> 或 </span><code>ether</code><span> 来实现的，如果后面没有单位，缺省为 Wei。例如 </span><code>2 ether == 2000 finney</code><span> 的逻辑判断值为 true</span></li></ul><ul><li><p><span>时间:秒是缺省时间单位，在时间单位之间，数字后面有 seconds、 minutes、 hours、 days、 weeks 和 years 的可以进行换算。规定一年365天。</span></p></li><li><p><span>这些后缀不能直接用在变量后边。如果想用时间单位(例如 days)来将输入变量 换算为时间，你可以用如下方式来完成:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="solidity"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="solidity"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">f</span>(<span class="cm-type">uint</span> <span class="cm-variable">start</span>, <span class="cm-type">uint</span> <span class="cm-variable">daysAfter</span>) <span class="cm-keyword">public</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> (<span class="cm-keyword">now</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">start</span> <span class="cm-operator">+</span> <span class="cm-variable">daysAfter</span> <span class="cm-operator">*</span> <span class="cm-number">1</span> <span class="cm-keyword">days</span>) { <span class="cm-comment">// ... }</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 81px;"></div><div class="CodeMirror-gutters" style="display: none; height: 81px;"></div></div></div></pre></li></ul></div></div>
</body>
</html>